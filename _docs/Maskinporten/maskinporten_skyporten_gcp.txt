
title: Skyporten med GCP - Maskinporten for deling av skyressurser
description:  Skyporten med GCP - Maskinporten for deling av skyressurser
summary: 'Oppskrift for 친 benytte Skyporten med GCP'
sidebar: maskinporten_sidebar
product: Maskinporten
redirect_from: /maskinporten_skyporten



TOC
{:toc}

For deg som skal tilby via GCP
P친 GCP er det workload identity federation som brukes for Skyporten sin Oauth2/OIDC-integrasjon.
N친 f칮lger en oppskrift p친 hvordan det kan gj칮res via gcloud. Ta kontakt med oss om du vil ha hjelp til 친 sette i gang.
Logg inn i gcloud
Her m친 du logge inn med den skybrukeren din organisasjon har gitt deg. Den b칮r ha brede nok privilegier (roller, policies)
til 친 kunne utf칮re oppgavene under.

Sett Google project
Dette er navnet p친 GCP prosjektet du 칮nsker 친 sette opp skyporten-tilgangen i.

Opprett en ny workload identity pool
Det er denne som benyttes for 친 f친 tilgang med Maskinporten ved hjelp av OIDC.
```
Du kan gjerne bytte ut navnet skyportenpoc
export WORKLOAD_POOL_ID=skyportenpoc
gcloud iam workload-identity-pools create "$WORKLOAD_POOL_ID" \
    --location="global" \
    --description="pool for skyporten poc" \
    --display-name="skyportenpoc try"
```
Definer OIDC identity pool provider
Legg merke til at vi her spesifiserer . Et spesifisert audience er p친krevd
av GCP og dermed anbefaler vi 친 velge en skyporten-prefiks til ditt eget domene. Dette behover ikke 친 v칝re et fungerende
domene.
Dette tvinger konsumenter til 친 spesfisere at Maskinporten-tokenet skal ha . Dette spesifiseres
i  n친r konsumenten bygger opp sin JWT-grant.
```
export REQUIRED_AUDIENCE="https://skyporten."
export PROVIDER_ID=skyportenprovider
gcloud iam workload-identity-pools providers create-oidc $PROVIDER_ID \
    --location="global" \
    --workload-identity-pool=$WORKLOAD_POOL_ID \
    --attribute-mapping="attribute.maskinportenscope"="assertion.scope","google.subject"="assertion.consumer.ID","attribute.clientaccess"="\"client::\" + assertion.consumer.ID + \"::\" + assertion.scope" \
    --issuer-uri="https://test.sky.maskinporten.no" \
    --allowed-audiences=$REQUIRED_AUDIENCE \
    --description="OIDC identity pool provider for Maskinporten"
```
Definisjonene under  mapper over til f칮lgende eksempler.  er her organisasjonsnummer til
konsumentorganisasjon. Disse kan brukes i til policies, for 친 tildele service account til enten et organisasjonsnummer,
et scope, eller kombinasjonen av organisasjon og scope. Se under policy binding
for eksempler

Opprett en service account som skal benyttes i poolen

Extract the email from the created SA
```
gcloud iam service-accounts list
skyportenstoragesa                         skyportenstorageconsumer@[project_id].iam.gserviceaccount.com        False
export SAEMAIL="skyportenstorageconsumer@[project_id].iam.gserviceaccount.com"
```
Create policy binding
Hent prosjektnummeret for prosjektet til workload identity poolen
```
find proj num in projects list
gcloud projects list
Export project number
export PROJNUM=[ number ]
```
Knytt sammen scope og organisasjonsnunmmer fra federert p친logging til service account og sett rollen 
som gj칮r det mulig 친 impersonate service account.
I eksemplet under gies tilgangen til organisasjonsnummer definert i  og scope i .

Dette er det mest fingranulerte tilgangsstyringen i Skyporten, hvor man f친r en service account per konsument og per scope.
Det gir mulighet til 친 trekke tilbake tilganger fra konsumenter som misbruker, uten 친 p친virke andre konsumenter.
Alternativer for definisjoner av principal set:
| Attribute | Mapping                                             | Beskrivelse                                                                                                   |
|-----------|-----------------------------------------------------|---------------------------------------------------------------------------------------------------------------|
| attribute.clientaccess |  | Gir tilgang til service account for akkurat en bestemt organisasjon n친r de identifiserer seg med dette scopet | 
| attribute.maskinportenscope |                                   | Gir tilgang til service account for alle organisasjoner n친r de identifiserer seg med dette scopet             |
| google.subject  |                                | Gir tilgang til service account for en bestemt organisasjon uavhengig av scopet som sendes                    |
Definer ressursen som skal deles
For 친 vise hvordan man kan dele en skyressurss, viser vi videre her med en nyopprettet b칮tte.
Dersom du allerede har opprettet ressursen som skal deles, kan du hoppe over denne.

Og laster opp en fil for 친 demonstrere
```
echo "bar" > foo.txt
gcloud storage cp foo.txt gs://$BUCKET/foo_remote.txt
Copying file://foo.txt to gs://skyportenbucket/foo_remote.txt
  Completed files 1/1 | 4.0B/4.0B
gcloud storage ls gs://$BUCKET
gs://skyportenbucket/foo_remote.txt
```
Knytt service account sammen med ressursen som skal deles
Her gir vi service-accounten tilgang til ressursen som skal deles. Dersom du skal dele noe eksisterende trenger du kun 친
gj칮re dette steget for at service account skal ha rett rolle eller permission p친 den aktuelle ressurssen.
Eksempelet her viser at vi gir den service accounten rett rolle for tilgang til den nyopprettede b칮tta.
```
gcloud storage buckets add-iam-policy-binding gs://$BUCKET --member=serviceAccount:$SAEMAIL --role=roles/storage.objectViewer
```
Enable IAM Service Account Credentials API
For at konsumenter skal kunne bruke impersonation, m친 IAM Service Account Credentials API enables for prosjektet

For deg som skal konsumere fra GCP
Oppsett
Prosjektet krever at man har et ekte Maskinporten-token mot det rette milj칮et.
Her er informasjon om hvordan du kommer i gang med Maskinporten.
Her er et node.js eksempel p친 token-generering for skyporten.
Det utpakkede tokenet ser slik ut:

Autentisering med Maskinporten-token med gcloud
Enten kan du f친 en -fil som er output fra  fra tilbyder,
eller du kan lage en selv gitt informasjon om f칮lgende variable fra tilbyder
```
export PROJNUM=[number]
export SAEMAIL=""
export WORKLOAD_POOL_ID=""
export PROVIDER_ID=""
export PROVIDER_FULL_IDENTIFIER=projects/${PROJNUM}/locations/global/workloadIdentityPools/${WORKLOAD_POOL_ID}/providers/${PROVIDER_ID}
export MASKINPORTEN_TOKEN_FILE=token.json
gcloud iam workload-identity-pools create-cred-config $PROVIDER_FULL_IDENTIFIER --service-account=$SAEMAIL --credential-source-type=json --credential-source-field-name=access_token --credential-source-file=$MASKINPORTEN_TOKEN_FILE --output-file=credentials.json
```
N친 vil credentials json se ut som eksempelet her

N친 m친 fila  inneholde kun json-responsen fra Maskinporten med selve tokenet i . Dette kan du se eksempler p친 i
disse kode-eksemplene.
Dersom du har en annen tekstfil med kun accesstoken i kan du endre parameterne til 
P친logging med gcloud vil da se ut som f칮lger

Og uthenting av eksempelfil
``````bash
gcloud storage ls gs://$BUCKET
gs://[bucket name]/foo_remote.txt
gcloud storage cp gs://$BUCKET/foo_remote.txt foo_local.txt
Copying gs://[bucket name]/foo_remote.txt to file://foo_local.txt
  Completed files 1/1 | 4.0B/4.0B
``````
Eksempel for konsument
Dersom du 칮nsker 친 teste ut 친 konsumere fra en filb칮tte, finnes det et 친pent scope i Maskinporten sitt test-milj칮 som du
kan benytte.
Scopet heter  og er et offentlig scope som ikke trenger noen form for tildeling.
Required audience i Maskinporten-tokenet er .  ligger p친 Slack
og forventer at fila token.json finnes og inneholder Maskinporten-token i atributtet .
Kj칮r deretter og velkommen!
游꿀

Feils칮king
Invalid JWT claim
Dette kan skyldes avsluttende skr친strek i .
N친r JWT-token genereres med audience , s친 m친 det gj칮res uten avsluttende skr친strek (trailing slash).
Hvis sp칮rringen mot Maskinporten har trailing slash i Token for  verdien vil man f친 feilen:

L칮sningen er alts친 친 fjerne avsluttende skr친strek i audience n친r man genererer JWT-token.